<!-- FILE: ./templates/editor.html -->

{% extends 'base.html' %}

{% block extra_head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    body {
        background-color: #1a1a1a;
        color: #e6e6e6;
        font-family: 'Fira Code', 'Consolas', monospace;
    }

    .editor-container {
        padding: 2rem;
    }

    .editor-header {
        background: #252525;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #document-title {
        color: #4ec9b0;
        font-size: 1.5rem;
        border: none;
        background: transparent;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: 'Fira Code', 'Consolas', monospace;
    }

    #document-title:focus {
        outline: none;
        background: #2d2d2d;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-family: 'Fira Code', 'Consolas', monospace;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #4ec9b0;
        color: #1a1a1a;
    }

    .btn-primary:hover {
        background: #3da892;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #252525;
        color: #4ec9b0;
        border: 1px solid #4ec9b0;
    }

    .btn-secondary:hover {
        background: #2d2d2d;
        color: #3da892;
        border-color: #3da892;
    }

    .editor-main {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 1.5rem;
    }

    #editor-container {
        background: #252525;
        border-radius: 8px;
        border: 1px solid #333;
        height: calc(100vh - 250px);
    }

    /* Quill Editor Styling */
    .ql-toolbar.ql-snow {
        background: #2d2d2d;
        border-color: #333;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #333;
    }

    .ql-container.ql-snow {
        border-color: #333;
        border-radius: 0 0 8px 8px;
        background: #252525;
        color: #e6e6e6;
    }

    .ql-editor {
        color: #e6e6e6;
    }

    .ql-snow .ql-stroke {
        stroke: #808080;
    }

    .ql-snow .ql-fill {
        fill: #808080;
    }

    .ql-snow .ql-picker {
        color: #808080;
    }

    .ql-snow .ql-picker-options {
        background-color: #252525;
        border-color: #333;
    }

    .ql-snow .ql-picker.ql-expanded .ql-picker-options {
        border-color: #333;
    }

    #comments-container {
        background: #252525;
        border-radius: 8px;
        border: 1px solid #333;
        padding: 1.5rem;
        height: calc(100vh - 250px);
        overflow-y: auto;
    }

    .comment {
        background: #2d2d2d;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #333;
        transition: all 0.2s ease;
    }

    .comment:hover {
        border-color: #4ec9b0;
        transform: translateY(-1px);
    }

    .comment .content {
        color: #e6e6e6;
    }

    .comment .meta {
        color: #808080;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .comment .resolve-btn {
        color: #4ec9b0;
        font-size: 0.875rem;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .comment .resolve-btn:hover {
        color: #3da892;
    }

    /* Highlighted text styling */
    .ql-editor span[data-comment-id] {
        background-color: rgba(78, 201, 176, 0.1);
        border-bottom: 1px solid #4ec9b0;
    }

    .ql-editor span[data-comment-id].highlighted {
        background-color: rgba(78, 201, 176, 0.2);
    }

    .ql-editor span[data-comment-id].active-highlight {
        background-color: rgba(78, 201, 176, 0.3);
    }

    /* Modal styling */
    .modal-content {
        background-color: #252525;
        border: 1px solid #333;
    }

    .modal-header {
        border-bottom: 1px solid #333;
        color: #e6e6e6;
    }

    .modal-footer {
        border-top: 1px solid #333;
    }

    .close {
        color: #808080;
    }

    .close:hover {
        color: #e6e6e6;
    }

    /* Version history list */
    .list-group-item {
        background-color: #2d2d2d;
        border: 1px solid #333;
        color: #e6e6e6;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }

    .list-group-item:hover {
        background-color: #333;
    }

    /* Active users section */
    #active-users {
        margin-top: 1.5rem;
        background: #252525;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #333;
    }

    .user-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        color: #e6e6e6;
    }

    .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #4ec9b0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1a1a1a;
        font-weight: bold;
    }

    .version-info {
        flex: 1;
        margin-right: 1rem;
    }

    .version-description {
        font-weight: 500;
        color: #e6e6e6;
        margin-bottom: 0.25rem;
    }

    .version-meta {
        font-size: 0.875rem;
        color: #808080;
    }

    .button-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn-outline-danger {
        color: #dc3545;
        border-color: #dc3545;
    }

    .btn-outline-danger:hover {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .btn-success {
        background-color: #4ec9b0;
        border-color: #4ec9b0;
        color: #1a1a1a;
        margin-left: 0.5rem;
    }

    .btn-success:hover {
        background-color: #3da892;
        border-color: #3da892;
        color: #1a1a1a;
    }

    .comment-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .comment-modal-content {
        background: #252525;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        color: #e6e6e6;
    }

    .selected-text, .comment-input, .suggest-edit {
        margin-bottom: 1rem;
    }

    .text-preview {
        background: #1e1e1e;
        padding: 0.5rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-family: 'Fira Code', monospace;
    }

    .comment-modal textarea {
        width: 100%;
        background: #1e1e1e;
        border: 1px solid #444;
        color: #e6e6e6;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: 'Fira Code', monospace;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1rem;
    }

    .modal-buttons button {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Fira Code', monospace;
    }

    .btn-submit {
        background: #61dafb;
        color: #1e1e1e;
        border: none;
    }

    .btn-cancel {
        background: transparent;
        color: #e6e6e6;
        border: 1px solid #444;
    }

    .suggest-edit {
        margin-top: 1rem;
    }

    .suggest-edit label {
        display: block;
        margin-bottom: 0.5rem;
    }

    #edit-container {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #2d2d2d;
        border-radius: 4px;
    }

    #edit-container label {
        color: #808080;
        font-size: 0.875rem;
    }

    #suggested-edit {
        margin-top: 0.5rem;
        width: 100%;
        background: #1e1e1e;
        border: 1px solid #444;
        color: #e6e6e6;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: 'Fira Code', monospace;
    }

    #suggested-edit:focus {
        border-color: #4ec9b0;
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-5">
    <div class="row">
        <!-- Editor Column -->
        <div class="col-md-9">
            <!-- Document Title and Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 contenteditable="true" id="document-title" class="mb-0">{{ document.title }}</h4>
                <div>
                    <!-- Save Button -->
                    <button type="button" class="btn btn-primary" id="save-button">Save</button>
                    <!-- Version History Button -->
                    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#versionHistoryModal">
                        Version History
                    </button>
                    <!-- Share Button -->
                    <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#collaboratorsModal">
                        Share
                    </button>
                    <!-- Download as Doc Button -->
                    <a href="{% url 'download_as_doc' document.pk %}" class="btn btn-success">
                        Download as Doc
                    </a>
                </div>
            </div>

            <!-- Editor Container -->
            <div id="editor-container"></div>

            <!-- Active Users List -->
            <div id="active-users" class="mt-4">
                <h6>Active Users:</h6>
                <div id="active-users-list" class="d-flex flex-wrap">
                    <!-- Active users will be listed here -->
                </div>
            </div>
        </div>

        <!-- Comments Sidebar -->
        <div class="col-md-3" id="comments-container">
            <h5>Comments</h5>
            <!-- Comments will be dynamically inserted here -->
        </div>
    </div>
</div>


<!-- Collaborators Modal -->
<div class="modal fade" id="collaboratorsModal" tabindex="-1" aria-labelledby="collaboratorsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="collaborators-form">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="collaborators_form">
          <div class="modal-header">
            <h5 class="modal-title" id="collaboratorsModalLabel">Share Document</h5>
          </div>
          <div class="modal-body">
            {{ collaborators_form.non_field_errors }}
            {% for field in collaborators_form %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                    {% for error in field.errors %}
                        <div class="invalid-feedback">
                            {{ error }}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionHistoryModal" tabindex="-1" aria-labelledby="versionHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Version History</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="version-list" class="list-group">
                    <!-- Versions will be loaded here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Version Preview Modal -->
<div class="modal fade" id="versionPreviewModal" tabindex="-1" aria-labelledby="versionPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Version Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="version-meta-info mb-3">
                    <div class="version-description h6"></div>
                    <small class="text-muted version-details"></small>
                </div>
                <div id="preview-editor-container" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirm-restore-btn">Restore This Version</button>
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- Include quill-cursors script -->
<script src="https://cdn.jsdelivr.net/npm/quill-cursors@3.0.0/dist/quill-cursors.min.js"></script>
<!-- Include Bootstrap JS (for modals) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Initialize Quill editor and WebSocket -->
<script>
    // Register QuillCursors module
    Quill.register('modules/cursors', window.QuillCursors);

    // Import Parchment
    var Parchment = Quill.import('parchment');

    // Define the 'comment' attribute attributor
    var CommentAttribute = new Parchment.Attributor.Attribute('comment', 'data-comment-id', {
        scope: Parchment.Scope.INLINE
    });

    // Register the 'comment' attribute attributor
    Quill.register(CommentAttribute, true);

    // Define the 'highlight' class attributor
    var HighlightClass = new Parchment.Attributor.Class('highlight', 'highlighted', {
        scope: Parchment.Scope.INLINE
    });

    Quill.register(HighlightClass, true);

    // Initialize Quill editor with cursors module and toolbar enabled
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            cursors: true,
            toolbar: {
                container: [
                    [{ 'font': [] }, { 'size': [] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'super' }, { 'script': 'sub' }],
                    [{ 'header': '1' }, { 'header': '2' }, 'blockquote', 'code-block'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1' }, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }, { 'align': [] }],
                    ['link', 'image', 'video', 'formula'],
                    ['clean'],
                    ['comment']  // Add the 'comment' button
                ],
                handlers: {
                    'comment': function() {
                        var range = quill.getSelection();
                        if (range && range.length > 0) {
                            const selectedText = quill.getText(range.index, range.length);
                            
                            // Create modal for comment input
                            const modal = document.createElement('div');
                            modal.className = 'comment-modal';
                            modal.innerHTML = `
                                <div class="comment-modal-content">
                                    <h3>Add Comment</h3>
                                    <div class="selected-text">
                                        <label>Selected Text:</label>
                                        <div class="text-preview">${selectedText}</div>
                                    </div>
                                    <div class="comment-input">
                                        <label>Comment:</label>
                                        <textarea id="comment-text" rows="3"></textarea>
                                    </div>
                                    <div class="suggest-edit">
                                        <label>
                                            <input type="checkbox" id="suggest-edit-toggle">
                                            Suggest an edit
                                        </label>
                                        <div id="edit-container" style="display: none;">
                                            <label>Replacement text:</label>
                                            <textarea id="suggested-edit" rows="3"></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-buttons">
                                        <button class="btn-cancel">Cancel</button>
                                        <button class="btn-submit">Submit</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(modal);

                            // Update the toggle handler
                            const editToggle = modal.querySelector('#suggest-edit-toggle');
                            const editContainer = modal.querySelector('#edit-container');
                            const editTextarea = modal.querySelector('#suggested-edit');

                            editToggle.addEventListener('change', function() {
                                editContainer.style.display = this.checked ? 'block' : 'none';
                                if (this.checked) {
                                    editTextarea.value = selectedText;
                                    editTextarea.focus();
                                    editTextarea.setSelectionRange(0, editTextarea.value.length);
                                }
                            });

                            // Handle submit
                            modal.querySelector('.btn-submit').addEventListener('click', function() {
                                const commentContent = modal.querySelector('#comment-text').value;
                                const suggestedEdit = editToggle.checked ? editTextarea.value : null;

                                if (commentContent) {
                                    const message = JSON.stringify({
                                        'type': 'comment',
                                        'comment': {
                                            'range': range,
                                            'content': commentContent,
                                            'suggested_edit': suggestedEdit
                                        }
                                    });
                                    socket.send(message);
                                }
                                modal.remove();
                            });

                            // Handle cancel
                            modal.querySelector('.btn-cancel').addEventListener('click', function() {
                                modal.remove();
                            });
                        } else {
                            alert('Please select text to comment on.');
                        }
                    }
                }
            }
        }
    });

    const cursors = quill.getModule('cursors');

    // Debounce function to delay execution until after events stop firing
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    const debouncedSendCursorPosition = debounce(sendCursorPosition, 100);

    // Set up WebSocket connection
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const documentId = "{{ document.pk }}";
    const socketUrl = `${wsScheme}://${window.location.host}/ws/document/${documentId}/`;
    const socket = new WebSocket(socketUrl);

    const myUserId = "{{ user.id }}";  // Store user ID as a string

    socket.onopen = function() {
        console.log('WebSocket connection established.');
        // Send initial cursor position
        sendCursorPosition();
    };

    // Function to dynamically find all ranges associated with a comment ID
    function findCommentRanges(commentId) {
        const delta = quill.getContents();
        let index = 0;
        let ranges = [];

        delta.ops.forEach(op => {
            let insertLength;
            if (typeof op.insert === 'string') {
                insertLength = op.insert.length;
            } else {
                insertLength = 1; // For embeds like images
            }

            if (op.attributes && op.attributes.comment === commentId.toString()) {
                ranges.push({ index: index, length: insertLength });
            }
            index += insertLength;
        });

        return ranges;
    }

    // Function to display a comment
    function displayComment(data) {
        var commentsContainer = document.getElementById('comments-container');
        if (!commentsContainer) return;

        var commentDiv = document.createElement('div');
        commentDiv.classList.add('comment');
        commentDiv.id = 'comment-' + data.comment.id;

        const hasEdit = data.comment.suggested_edit !== null;
        
        commentDiv.innerHTML = `
            <div class="content">${data.comment.content}</div>
            ${hasEdit ? `
                <div class="suggested-edit">
                    <div class="edit-label">Suggested Edit:</div>
                    <div class="edit-content">${data.comment.suggested_edit}</div>
                    <button class="apply-edit-btn" onclick="applyEdit(${data.comment.id}); event.stopPropagation();">
                        Apply Edit
                    </button>
                </div>
            ` : ''}
            <div class="meta">By ${data.username}</div>
            <div class="resolve-btn" onclick="resolveComment(${data.comment.id}); event.stopPropagation();">
                Resolve
            </div>
        `;

        commentsContainer.appendChild(commentDiv);

        // Update the 'comment' format with the actual comment ID
        quill.formatText(
            data.comment.range.index,
            data.comment.range.length,
            'comment',
            data.comment.id
        );

        // Add event listeners for hovering over the comment
        commentDiv.addEventListener('mouseenter', function() {
            highlightText(data.comment.id);
        });

        commentDiv.addEventListener('mouseleave', function() {
            removeTextHighlight(data.comment.id);
        });

        // Add event listener for clicking on the comment
        commentDiv.addEventListener('click', function() {
            navigateToEditorComment(data.comment.id);
        });
    }

    // Function to highlight text when hovering over a comment
    function highlightText(commentId) {
        let ranges = findCommentRanges(commentId);
        ranges.forEach(range => {
            quill.formatText(range.index, range.length, 'highlight', true, 'silent');
        });
    }

    // Function to remove the highlight from text
    function removeTextHighlight(commentId) {
        let ranges = findCommentRanges(commentId);
        ranges.forEach(range => {
            quill.formatText(range.index, range.length, 'highlight', false, 'silent');
        });
    }

    // Function to navigate to the comment in the editor
    function navigateToEditorComment(commentId) {
        let ranges = findCommentRanges(commentId);
        if (ranges.length > 0) {
            let range = ranges[0]; // Navigate to the first range
            // Scroll to the comment's position in the editor
            quill.scrollIntoView(quill.getBounds(range.index));

            // Set the selection to highlight the text (optional)
            quill.setSelection(range.index, range.length, 'silent');

            // Add a temporary active highlight
            quill.formatText(range.index, range.length, 'active-highlight', true, 'silent');
            setTimeout(() => {
                quill.formatText(range.index, range.length, 'active-highlight', false, 'silent');
            }, 2000);
        }
    }

    // Function to remove a comment from the sidebar and editor
    function removeComment(commentId, isLocal = false) {
        var commentDiv = document.getElementById('comment-' + commentId);
        if (commentDiv) {
            commentDiv.remove();
        }

        let ranges = findCommentRanges(commentId);
        if (ranges.length > 0) {
            ranges.forEach(range => {
                // Remove the 'comment' format from the specified range
                quill.formatText(range.index, range.length, 'comment', false, 'silent');
            });

            if (isLocal) {
                // If the removal is initiated locally (by resolving the comment),
                // send a delta to the server to inform other clients.
                let Delta = Quill.import('delta');
                let delta = new Delta();
                let position = 0;
                ranges.forEach(range => {
                    delta.retain(range.index - position);
                    delta.retain(range.length, { 'comment': false });
                    position = range.index + range.length;
                });

                var message = JSON.stringify({ 'type': 'delta', 'delta': delta.ops });
                socket.send(message);
            }
        }
    }

    // Function to resolve a comment
    function resolveComment(commentId) {
        // Send a message to the server to resolve the comment
        var message = JSON.stringify({
            'type': 'resolve_comment',
            'comment_id': commentId
        });
        socket.send(message);

        // Remove the comment locally and indicate it's a local action
        removeComment(commentId, true);
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'init') {
            // Set the initial content
            quill.setContents(data.content);
        } else if (data.type === 'delta') {
            // Apply the delta to the Quill editor
            const delta = { ops: data.delta };
            quill.updateContents(delta);

            // Transform the cursors based on the delta
            cursors.transformCursors(delta);
        } else if (data.type === 'cursor') {
            // Update cursor position
            if (data.user_id !== myUserId) {
                const userIdStr = data.user_id.toString();
                // Check if cursor already exists
                if (!cursors.cursors()[userIdStr]) {
                    cursors.createCursor(userIdStr, data.username, data.color);
                }
                if (data.range) {
                    cursors.moveCursor(userIdStr, {
                        index: Number(data.range.index),
                        length: Number(data.range.length)
                    });
                } else {
                    cursors.removeCursor(userIdStr);
                }
            }
        } else if (data.type === 'comment') {
            // Display the comment
            displayComment(data);
        } else if (data.type === 'resolve_comment') {
            // Remove the comment without sending a delta back
            removeComment(data.comment_id, false);
        } else if (data.type === 'user_left') {
            // Remove cursor when user disconnects
            cursors.removeCursor(data.user_id.toString());
        } else if (data.type === 'active_users') {
            // Update the list of active users
            updateActiveUsersList(data.users);
        }
    };

    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    socket.onclose = function() {
        console.log('WebSocket connection closed.');
    };

    // Send changes to the server
    quill.on('text-change', function(delta, oldDelta, source) {
        if (source === 'user') {
            let index = 0;
            delta.ops.forEach(function(op) {
                if (op.retain) {
                    index += op.retain;
                } else if (op.insert) {
                    let length = op.insert.length || 1;
                    // Remove 'comment' format from the inserted text
                    quill.formatText(index, length, 'comment', false, 'silent');
                    index += length;
                } else if (op.delete) {
                    // Deletion, do nothing
                }
            });
            const deltaOps = delta.ops;
            const message = JSON.stringify({'type': 'delta', 'delta': deltaOps});
            socket.send(message);

            // Send cursor position (debounced)
            debouncedSendCursorPosition();
        }
    });

    // Send cursor position to the server (debounced)
    quill.on('selection-change', function(range, oldRange, source) {
        if (source === 'user') {
            debouncedSendCursorPosition();
        }
    });

    function sendCursorPosition() {
        const range = quill.getSelection();
        const message = JSON.stringify({
            'type': 'cursor',
            'range': range
        });
        socket.send(message);
    }

    // Function to update active users list
    function updateActiveUsersList(users) {
        const activeUsersListContainer = document.getElementById('active-users-list');
        if (activeUsersListContainer) {
            activeUsersListContainer.innerHTML = '';
            users.forEach(function(user) {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';

                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.style.backgroundColor = user.color;
                avatar.textContent = user.username.charAt(0).toUpperCase();

                const username = document.createElement('div');
                username.className = 'username';
                username.textContent = user.username;

                userElement.appendChild(avatar);
                userElement.appendChild(username);
                activeUsersListContainer.appendChild(userElement);
            });
        }
    }

    // Update document title
    const titleElement = document.getElementById('document-title');
    titleElement.addEventListener('blur', function() {
        const newTitle = titleElement.textContent.trim();
        if (newTitle !== "{{ document.title }}") {
            // Send a POST request to update the title
            fetch("{% url 'document_edit' document.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'title': newTitle })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Title updated successfully.');
                } else {
                    console.error('Error updating title:', response.statusText);
                }
            })
            .catch(error => {
                console.error('Error updating title:', error);
            });
        }
    });

    // Load existing comments when initializing the editor
    fetch("{% url 'get_comments' document.pk %}")
        .then(response => response.json())
        .then(data => {
            data.comments.forEach(comment => {
                displayComment({
                    comment: comment,
                    username: comment.username
                });
            });
        });

    // --- Save Button Functionality ---
    document.getElementById('save-button').addEventListener('click', function() {
        // Prompt for version description
        const description = prompt('Enter a description for this version:', '');
        if (description !== null) {  // Only save if user didn't cancel the prompt
            // Get the current content of the editor
            const content = quill.getContents();

            // Send an AJAX POST request to save the version
            fetch("{% url 'save_version' document.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'content': content,
                    'description': description
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Document saved successfully.');
                    loadVersions();  // Reload the version list after successful save
                } else {
                    alert('Error saving document.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving document.');
            });
        }
    });

    // --- Version History Functionality ---

    // Initialize preview editor
    const previewQuill = new Quill('#preview-editor-container', {
        theme: 'snow',
        modules: {
            toolbar: false
        },
        readOnly: true
    });

    // Function to load versions
    function loadVersions() {
        fetch("{% url 'list_versions' document.pk %}")
            .then(response => response.json())
            .then(data => {
                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';
                data.versions.forEach(version => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    // Create description container
                    const descContainer = document.createElement('div');
                    descContainer.className = 'version-info';
                    descContainer.innerHTML = `
                        <div class="version-description">${version.description || 'No description'}</div>
                        <div class="version-meta">Saved by ${version.username} at ${version.created_at}</div>
                    `;
                    
                    // Create button container
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'button-group';

                    // Create preview button
                    const previewButton = document.createElement('button');
                    previewButton.className = 'btn btn-sm btn-outline-secondary mr-2';
                    previewButton.textContent = 'Preview';
                    previewButton.addEventListener('click', () => showVersionPreview(version.id));

                    // Create delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-sm btn-outline-danger';
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', () => deleteVersion(version.id));

                    buttonContainer.appendChild(previewButton);
                    buttonContainer.appendChild(deleteButton);

                    listItem.appendChild(descContainer);
                    listItem.appendChild(buttonContainer);
                    versionList.appendChild(listItem);
                });
            });
    }

    // Function to show version preview
    function showVersionPreview(versionId) {
        fetch(`{% url 'preview_version' document.pk 0 %}`.replace('0', versionId))
            .then(response => response.json())
            .then(data => {
                // Set the preview content
                previewQuill.setContents(data.content);
                
                // Update meta information
                document.querySelector('#versionPreviewModal .version-description').textContent = 
                    data.description || 'No description';
                document.querySelector('#versionPreviewModal .version-details').textContent = 
                    `Saved by ${data.username} at ${data.created_at}`;
                
                // Store version ID for restore functionality
                document.getElementById('confirm-restore-btn').dataset.versionId = versionId;
                
                // Hide version history modal and show preview modal
                $('#versionHistoryModal').modal('hide');
                $('#versionPreviewModal').modal('show');
            });
    }

    // Handle restore button click in preview modal
    document.getElementById('confirm-restore-btn').addEventListener('click', function() {
        const versionId = this.dataset.versionId;
        restoreVersion(versionId);
    });

    // Update modal behavior
    $('#versionPreviewModal').on('hidden.bs.modal', function () {
        $('#versionHistoryModal').modal('show');
    });

    // Add CSS for the preview modal
    const style = document.createElement('style');
    style.textContent = `
        #preview-editor-container .ql-editor {
            background: #252525;
            color: #e6e6e6;
        }
        
        .version-meta-info {
            border-bottom: 1px solid #333;
            padding-bottom: 1rem;
        }
    `;
    document.head.appendChild(style);

    // Load versions when the modal is opened
    $('#versionHistoryModal').on('show.bs.modal', function() {
        loadVersions();
    });

    // Function to restore a version
    function restoreVersion(versionId) {
        if (confirm('Are you sure you want to restore this version? This will overwrite the current document content.')) {
            fetch("{% url 'restore_version' document.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'version_id': versionId
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Error restoring version.');
            })
            .then(data => {
                // Update the editor content
                quill.setContents(JSON.parse(data.content));
                // Close both modals
                $('#versionPreviewModal').modal('hide');
                $('#versionHistoryModal').modal('hide');
                alert('Version restored successfully.');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error restoring version.');
            });
        }
    }

    // Add the deleteVersion function
    function deleteVersion(versionId) {
        if (confirm('Are you sure you want to delete this version? This action cannot be undone.')) {
            fetch("{% url 'delete_version' document.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'version_id': versionId
                })
            })
            .then(response => {
                if (response.ok) {
                    loadVersions();  // Reload the version list
                } else {
                    alert('Error deleting version.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting version.');
            });
        }
    }

    // Add function to apply edit
    function applyEdit(commentId) {
        const comment = document.getElementById('comment-' + commentId);
        const ranges = findCommentRanges(commentId);
        
        if (ranges.length > 0) {
            const suggestedEdit = comment.querySelector('.edit-content').textContent;
            const range = ranges[0];
            
            // Create a delta for the text replacement
            let Delta = Quill.import('delta');
            let delta = new Delta()
                .retain(range.index)
                .delete(range.length)
                .insert(suggestedEdit);
            
            // Apply the change locally
            quill.updateContents(delta, 'user');
            
            // Send the delta to other clients
            const message = JSON.stringify({
                'type': 'delta',
                'delta': delta.ops
            });
            socket.send(message);
            
            // Resolve the comment after applying the edit
            resolveComment(commentId);
        }
    }
</script>
{% endblock %}