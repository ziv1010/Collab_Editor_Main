{% extends 'base.html' %}

{% block extra_head %}
<!-- Include Quill stylesheet -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h2>{{ document.title }}</h2>
<!-- Back to Documents Link -->
<p><a href="{% url 'document_list' %}">Back to Your Documents</a></p>
<!-- Editor container -->
<div id="editor-container"></div>

<!-- Safely include the content using json_script -->
{{ document.content|default:'""'|json_script:"initial-content" }}
{% endblock %}

{% block extra_script %}
<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- Initialize Quill editor -->
<script>
    var quill = new Quill('#editor-container', {
        theme: 'snow'
    });

    // Load the content from the server
    var initialContentElement = document.getElementById('initial-content');
    var initialContent = JSON.parse(initialContentElement.textContent);
    if (initialContent && initialContent.ops && initialContent.ops.length > 0) {
        quill.setContents(initialContent);
    }

    // Autosave content
    quill.on('text-change', function() {
        // Send the content to the server via fetch API
        var content = JSON.stringify(quill.getContents());
        fetch("{% url 'document_edit' document.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'content': content})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    });
</script>
{% endblock %}