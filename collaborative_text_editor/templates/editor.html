{% extends 'base.html' %}

{% block extra_head %}
<!-- Include Quill stylesheet -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h2>{{ document.title }}</h2>
<!-- Back to Documents Link -->
<p><a href="{% url 'document_list' %}">Back to Your Documents</a></p>
<!-- Editor container -->
<div id="editor-container"></div>

<!-- Safely include the content using json_script -->
{{ document.content|default:'{}'|json_script:"initial-content" }}

<!-- Manual Save Button -->
<button id="save-button">Save</button>
{% endblock %}

{% block extra_script %}
<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- Initialize Quill editor -->
<script>
    // Function to retrieve a cookie by name
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Retrieve CSRF token from cookies
    const csrftoken = getCookie('csrftoken');

    // Initialize Quill editor
    var quill = new Quill('#editor-container', {
        theme: 'snow'
    });

    // Load the content from the server
    var initialContentElement = document.getElementById('initial-content');
    var initialContent = JSON.parse(initialContentElement.textContent);
    if (initialContent && initialContent.ops && initialContent.ops.length > 0) {
        quill.setContents(initialContent);
    }

    // Function to save content to the server
    function saveContent() {
        var content = quill.getContents(); // Get the delta object directly
        fetch("{% url 'document_edit' document.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'content': content})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Optional: Show a save confirmation to the user
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
            // Optional: Notify the user about the error
        });
    }

    // Autosave content with debouncing (save after 2 seconds of inactivity)
    let timeoutId;
    quill.on('text-change', function() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function() {
            saveContent();
        }, 2000); // 2000 milliseconds = 2 seconds
    });

    // Manual Save Button Event Listener
    document.getElementById('save-button').addEventListener('click', function() {
        saveContent();
        alert('Document saved successfully.');
    });
</script>
{% endblock %}