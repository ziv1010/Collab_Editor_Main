{% extends 'base.html' %}

{% block extra_head %}
<!-- Include Quill stylesheet -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h2>{{ document.title }}</h2>
<!-- Back to Documents Link -->
<p><a href="{% url 'document_list' %}">Back to Your Documents</a></p>

<!-- Form to edit document title and collaborators -->
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Update Document</button>
</form>

<!-- Editor container -->
<div id="editor-container"></div>
{% endblock %}

{% block extra_script %}
<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- Initialize Quill editor and WebSocket -->
<script>
    // Initialize Quill editor
    var quill = new Quill('#editor-container', {
        theme: 'snow'
    });

    // Track whether the editor is applying remote changes
    var applyingRemoteChange = false;

    // Set up WebSocket connection
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var documentId = "{{ document.pk }}";
    var socketUrl = ws_scheme + '://' + window.location.host + '/ws/document/' + documentId + '/';
    var socket = new WebSocket(socketUrl);

    socket.onopen = function(e) {
        console.log('WebSocket connection established.');
    };

    socket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.type === 'init') {
            // Set the initial content
            quill.setContents(data.content);
        } else if (data.type === 'delta') {
            // Apply the delta to the Quill editor
            applyingRemoteChange = true;
            quill.updateContents(data.delta);
            applyingRemoteChange = false;
        }
    };

    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    socket.onclose = function(e) {
        console.log('WebSocket connection closed.');
    };

    // Send changes to the server
    quill.on('text-change', function(delta, oldDelta, source) {
        if (source === 'user' && !applyingRemoteChange) {
            var message = JSON.stringify(delta);
            socket.send(message);
        }
    });
</script>

{% endblock %}
