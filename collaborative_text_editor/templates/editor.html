{% extends 'base.html' %}

{% block extra_head %}
<!-- Include Quill stylesheet -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Include quill-cursors stylesheet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-cursors@3.0.0/dist/quill-cursors.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Document Title and Sharing Options -->
        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
            <div>
                <h4 contenteditable="true" id="document-title">{{ document.title }}</h4>
            </div>
            <div>
                <!-- Collaborators Modal Trigger -->
                <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#collaboratorsModal">
                    Share
                </button>
            </div>
        </div>
    </div>
    <div class="col-12">
        <!-- Editor container -->
        <div id="editor-container"></div>
    </div>
</div>

<!-- Collaborators Modal -->
<div class="modal fade" id="collaboratorsModal" tabindex="-1" role="dialog" aria-labelledby="collaboratorsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" id="collaborators-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="collaboratorsModalLabel">Share Document</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {{ form.non_field_errors }}
          {{ form.collaborators }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Active Users List -->
<div id="active-users" class="mt-3">
    <h5>Active Users:</h5>
    <div id="active-users-list" class="d-flex">
        <!-- Active users will be listed here -->
    </div>
</div>
{% endblock %}

{% block extra_script %}
<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- Include quill-cursors script -->
<script src="https://cdn.jsdelivr.net/npm/quill-cursors@3.0.0/dist/quill-cursors.min.js"></script>

<!-- Initialize Quill editor and WebSocket -->
<script>
    // Include the QuillCursors module
    var QuillCursors = window.QuillCursors;
    Quill.register('modules/cursors', QuillCursors);

    // Initialize Quill editor with the cursors module and toolbar enabled
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            cursors: true,
            toolbar: [
                [{ 'font': [] }, { 'size': [] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'script': 'super' }, { 'script': 'sub' }],
                [{ 'header': '1' }, { 'header': '2' }, 'blockquote', 'code-block'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }, { 'align': [] }],
                ['link', 'image', 'video', 'formula'],
                ['clean']
            ]
        }
    });

    var cursors = quill.getModule('cursors');

    // Debounce function to delay execution until after events stop firing
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    var debouncedSendCursorPosition = debounce(sendCursorPosition, 100);

    // Set up WebSocket connection
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var documentId = "{{ document.pk }}";
    var socketUrl = ws_scheme + '://' + window.location.host + '/ws/document/' + documentId + '/';
    var socket = new WebSocket(socketUrl);

    var myUserId = "{{ user.id }}";  // Store user ID as a string

    socket.onopen = function(e) {
        console.log('WebSocket connection established.');
        // Send initial cursor position
        sendCursorPosition();
    };

    socket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.type === 'init') {
            // Set the initial content
            quill.setContents(data.content);
        } else if (data.type === 'delta') {
            // Apply the delta to the Quill editor
            var delta = { ops: data.delta };
            quill.updateContents(delta);

            // Transform the cursors based on the delta
            cursors.transformCursors(delta);
        } else if (data.type === 'cursor') {
            // Update cursor position
            if (data.user_id !== myUserId) {
                var userIdStr = data.user_id.toString();
                // Check if cursor already exists
                if (!cursors.cursors().hasOwnProperty(userIdStr)) {
                    cursors.createCursor(userIdStr, data.username, data.color);
                }
                if (data.range) {
                    // Ensure that data.range.index and data.range.length are numbers
                    var range = data.range;
                    range.index = Number(range.index);
                    range.length = Number(range.length);
                    cursors.moveCursor(userIdStr, range);
                } else {
                    cursors.removeCursor(userIdStr);
                }
            }
        } else if (data.type === 'user_left') {
            // Remove cursor when user disconnects
            cursors.removeCursor(data.user_id.toString());
        } else if (data.type === 'active_users') {
            // Update the list of active users
            updateActiveUsersList(data.users);
        }
    };

    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    socket.onclose = function(e) {
        console.log('WebSocket connection closed.');
    };

    // Send changes to the server
    quill.on('text-change', function(delta, oldDelta, source) {
        if (source === 'user') {
            var deltaOps = delta.ops;
            var message = JSON.stringify({'type': 'delta', 'delta': deltaOps});
            socket.send(message);

            // Send cursor position (debounced)
            debouncedSendCursorPosition();
        }
    });

    // Send cursor position to the server (debounced)
    quill.on('selection-change', function(range, oldRange, source) {
        if (source === 'user') {
            debouncedSendCursorPosition();
        }
    });

    function sendCursorPosition() {
        var range = quill.getSelection();
        var message = JSON.stringify({
            'type': 'cursor',
            'range': range
        });
        socket.send(message);
    }

    // Function to update active users list
    function updateActiveUsersList(users) {
        var activeUsersListContainer = document.getElementById('active-users-list');
        if (activeUsersListContainer) {
            activeUsersListContainer.innerHTML = '';
            users.forEach(function(user) {
                var userElement = document.createElement('div');
                userElement.className = 'mr-3 text-center';
                var avatar = document.createElement('div');
                avatar.style.width = '40px';
                avatar.style.height = '40px';
                avatar.style.borderRadius = '50%';
                avatar.style.backgroundColor = user.color;
                avatar.style.color = '#fff';
                avatar.style.display = 'flex';
                avatar.style.alignItems = 'center';
                avatar.style.justifyContent = 'center';
                avatar.style.fontWeight = 'bold';
                avatar.textContent = user.username.charAt(0).toUpperCase();
                userElement.appendChild(avatar);
                var username = document.createElement('div');
                username.style.fontSize = '12px';
                username.textContent = user.username;
                userElement.appendChild(username);
                activeUsersListContainer.appendChild(userElement);
            });
        }
    }

    // Update document title
    var titleElement = document.getElementById('document-title');
    titleElement.addEventListener('blur', function() {
        var newTitle = titleElement.textContent.trim();
        if (newTitle !== "{{ document.title }}") {
            // Send an AJAX request to update the title
            $.ajax({
                url: "{% url 'document_edit' document.pk %}",
                method: 'POST',
                data: {
                    'title': newTitle,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('Title updated successfully.');
                },
                error: function(xhr, status, error) {
                    console.error('Error updating title:', error);
                }
            });
        }
    });
</script>
{% endblock %}
